name: Build and Deploy .deb

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - '*.csproj'
      - 'debian/**'
      - '.github/workflows/build-deploy.yml'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # .NET 10 is already installed system-wide on the self-hosted runner
      - name: Verify .NET version
        run: dotnet --version
      
      # Auto-increment version using GitHub run number + attempt
      - name: Calculate version
        id: version
        run: |
          # Base version (major.minor) from csproj, patch = GitHub run number
          # Add run_attempt to ensure unique version on re-runs
          MAJOR=1
          MINOR=0
          RUN=${{ github.run_number }}
          ATTEMPT=${{ github.run_attempt }}
          if [ "$ATTEMPT" -gt 1 ]; then
            PATCH="${RUN}${ATTEMPT}"
          else
            PATCH="$RUN"
          fi
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --configuration Release --no-restore
      
      - name: Create .deb package
        run: |
          dotnet msbuild src/SpeechToText.App/SpeechToText.App.csproj \
            /t:CreateDeb /p:Configuration=Release /p:Version=${{ steps.version.outputs.version }}
      
      - name: Find .deb file
        id: find-deb
        run: |
          DEB_FILE=$(find . -name "*.deb" -type f | head -1)
          echo "Found: $DEB_FILE"
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
      
      - name: Deploy to APT repository
        run: |
          DEB_FILE="${{ steps.find-deb.outputs.deb_file }}"
          APT_REPO="$HOME/apt-repo"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Copying $DEB_FILE to $APT_REPO/pool/main/"
          cp -f "$DEB_FILE" "$APT_REPO/pool/main/"
          
          cd "$APT_REPO"
          
          # Remove ALL old versions to ensure clean state
          echo "Removing old package versions..."
          rm -f pool/main/speech-to-text.*.deb 2>/dev/null || true
          
          # Copy the new package again (in case it was deleted)
          cp -f "$GITHUB_WORKSPACE/$DEB_FILE" "$APT_REPO/pool/main/" 2>/dev/null || cp -f "$DEB_FILE" "$APT_REPO/pool/main/"
          
          echo "Generating Packages index..."
          dpkg-scanpackages pool/main/ > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages
          
          echo "Generating Release file..."
          cat > dists/stable/Release << EOF
          Origin: Local Applications
          Label: LocalApps
          Suite: stable
          Codename: stable
          Version: 1.0
          Architectures: amd64
          Components: main
          Description: Local APT repository for SpeechToText
          EOF
          # Append checksums from apt-ftparchive
          apt-ftparchive release dists/stable >> dists/stable/Release
          
          echo "APT repository updated with version $VERSION!"
          echo "Users can now run: sudo apt update && sudo apt upgrade"
      
      - name: Auto-upgrade local installation
        run: |
          echo "Updating APT cache..."
          sudo apt update
          echo "Reinstalling speech-to-text package to ensure latest version..."
          sudo apt install --reinstall -y speech-to-text
          echo "Package installed: version ${{ steps.version.outputs.version }}"
          # Verify installed version
          dpkg -l speech-to-text | grep speech-to-text
      
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ steps.find-deb.outputs.deb_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APT repo updated:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "- **Local installation upgraded:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Package automatically upgraded on local system." >> $GITHUB_STEP_SUMMARY
