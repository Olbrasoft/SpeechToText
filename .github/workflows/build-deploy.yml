name: Build and Deploy .deb

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - '*.csproj'
      - 'debian/**'
      - '.github/workflows/build-deploy.yml'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # .NET 10 is already installed system-wide on the self-hosted runner
      - name: Verify .NET version
        run: dotnet --version
      
      # Auto-increment version using GitHub run number
      - name: Calculate version
        id: version
        run: |
          # Base version (major.minor) from csproj, patch = GitHub run number
          MAJOR=1
          MINOR=0
          PATCH=${{ github.run_number }}
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --configuration Release --no-restore
      
      - name: Create .deb package
        run: |
          dotnet msbuild src/Olbrasoft.SpeechToText.App/Olbrasoft.SpeechToText.App.csproj \
            /t:CreateDeb /p:Configuration=Release /p:Version=${{ steps.version.outputs.version }}
      
      - name: Find .deb file
        id: find-deb
        run: |
          DEB_FILE=$(find . -name "*.deb" -type f | head -1)
          echo "Found: $DEB_FILE"
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
      
      - name: Deploy to APT repository
        run: |
          DEB_FILE="${{ steps.find-deb.outputs.deb_file }}"
          APT_REPO="$HOME/apt-repo"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Copying $DEB_FILE to $APT_REPO/pool/main/"
          cp "$DEB_FILE" "$APT_REPO/pool/main/"
          
          cd "$APT_REPO"
          
          # Remove old versions to keep only the latest
          echo "Removing old package versions..."
          ls pool/main/speech-to-text.*.deb | sort -V | head -n -1 | xargs -r rm -v
          
          echo "Generating Packages index..."
          dpkg-scanpackages pool/main/ > dists/stable/main/binary-amd64/Packages
          gzip -k -f dists/stable/main/binary-amd64/Packages
          
          echo "Generating Release file..."
          cat > dists/stable/Release << EOF
          Origin: Local Applications
          Label: LocalApps
          Suite: stable
          Codename: stable
          Version: 1.0
          Architectures: amd64
          Components: main
          Description: Local APT repository for SpeechToText
          EOF
          # Append checksums from apt-ftparchive
          apt-ftparchive release dists/stable >> dists/stable/Release
          
          echo "APT repository updated with version $VERSION!"
          echo "Users can now run: sudo apt update && sudo apt upgrade"
      
      - name: Auto-upgrade local installation
        run: |
          echo "Updating APT and upgrading speech-to-text package..."
          sudo apt update && sudo apt upgrade -y speech-to-text
          echo "Package upgraded to version ${{ steps.version.outputs.version }}"
      
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ steps.find-deb.outputs.deb_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APT repo updated:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "- **Local installation upgraded:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Package automatically upgraded on local system." >> $GITHUB_STEP_SUMMARY
